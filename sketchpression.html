<!DOCTYPE html>
<html lang="en">
    <head>
        <title>sketchpression - kvkontin</title>
        <meta charset="utf-8">
        <style>
            
            * {
                color: white;
                font-family: Verdana, sans-serif;
                font-size: 20px;
                background-color: #002b36;
            }

            canvas {
                border:1px solid;
            }

            .text {
                width: 640px;
            }

        </style>
        <script src="https://cdn.jsdelivr.net/npm/mathjs@9.4.4/lib/browser/math.js"></script>
    </head>

    <body>
        <canvas id="customCanvas" width="640" height="640">Canvas tags are not supported</canvas>
        <p id="canvasText">Waiting</p>
        <input id="style" type="checkbox">
        <label for="style">Only sign</label>
        <br>
        <input id="expression" class="text" type="text" value="x+sin(y)">
        <br>
        <input id="draw" type="button" value="Draw" onclick="drawFull()">
        <p></p>
        <img src="https://i.imgur.com/HOOCESq.png" width="100" height="100" alt="kvkontin">

        <script type="text/javascript">

            const customCanvas = document.getElementById("customCanvas");
            const canvasContext = customCanvas.getContext("2d");
            const canvasText = document.getElementById("canvasText");
            const expressionField = document.getElementById("expression");
            const styleCheckbox = document.getElementById("style");
    
            const mipmapLevels = [32, 8, 4, 1];
            let onlySign = false;
            let expression = "1";
            let mipmapIndex = 0;
            let mipmapX = 0

            function calculateSpot(horizontal, vertical) {
                let scope = {
                    x: horizontal,
                    y: vertical
                }
                return math.evaluate(expression, scope);
            }

            function drawMipmapped() {
                blockSize = mipmapLevels[mipmapIndex];
                canvasText.innerHTML = "Drawing at scale "+blockSize;

                for(let mipmapY = 0; mipmapY < customCanvas.height+blockSize; mipmapY+=blockSize) {
                    let xFrac = 2*mipmapX/customCanvas.width-1;
                    let yFrac = -2*mipmapY/customCanvas.height+1;
                    let lightness = calculateSpot(xFrac, yFrac);
                    if(onlySign) {
                        lightness = (lightness >= 0);
                    }
                    let byte = lightness*255;
                    canvasContext.fillStyle = `rgb(${byte},${byte},${byte})`;
                    if(blockSize > 1) {
                        canvasContext.fillRect(mipmapX-blockSize/2,mipmapY-blockSize/2,blockSize,blockSize);
                    }
                    else {
                        canvasContext.fillRect(mipmapX,mipmapY,1,1);
                    }
                }

                mipmapX += blockSize;

                if(mipmapX >= customCanvas.width + blockSize) {
                    if(mipmapIndex >= mipmapLevels.length-1) {
                        canvasText.innerText = "Finished";
                        return;
                    }
                    else {
                        mipmapIndex += 1;
                        mipmapX = 0;
                    }
                }
                setTimeout(drawMipmapped, 0);
            }

            function drawFull() {
                expression = expressionField.value;
                onlySign = styleCheckbox.checked;
                mipmapIndex = 0;
                mipmapX = 0;
                drawMipmapped();
            }
        </script>

    </body>
</html>