<!DOCTYPE html>
<html lang="en">
    <head>
        <title>sketchpression - kvkontin</title>
        <meta charset="utf-8">
        <style>
            
            * {
                color: white;
                font-family: Verdana, sans-serif;
                font-size: 20px;
                background-color: #002b36;
            }

            canvas {
                border:1px solid;
            }

            .text {
                width: 640px;
            }

        </style>
        <script src="https://cdn.jsdelivr.net/npm/mathjs@9.4.4/lib/browser/math.js"></script>
    </head>

    <body>
        <canvas id="customCanvas" width="640" height="640">Canvas tags are not supported</canvas>
        <p id="canvasText">Waiting</p>
        <input id="resolution" type="range" min="1" max="32" value="1" step="1">
        <label for="resolution">Block size</label>
        <br>
        <input id="style" type="checkbox">
        <label for="style">Only sign</label>
        <input id="gamma" type="checkbox">
        <label for="gamma">Gamma correction</label>
        <br>
        <input id="expression" class="text" type="text" value="x^2+y^2">
        <br>
        <input id="draw" type="button" value="Draw" onclick="drawFull()">
        <p></p>
        <img src="https://i.imgur.com/HOOCESq.png" width="100" height="100" alt="kvkontin">


        <script type="text/javascript">

            const customCanvas = document.getElementById("customCanvas");
            const canvasContext = customCanvas.getContext("2d");
            const canvasText = document.getElementById("canvasText");
            const expressionField = document.getElementById("expression");
            const styleCheckbox = document.getElementById("style");
            const resolutionSlider = document.getElementById("resolution");
            const gammaCheckbox = document.getElementById("gamma");
    
            let onlySign = false;
            let gamma = false;
            let expression = "1";
            let blockSize = 1;
            let code = "";

            function calculateSpot(horizontal, vertical) {
                let scope = {
                    x: horizontal,
                    y: vertical
                }
                try {
                    return code.evaluate(scope);
                }
                catch(error) {
                    if(error.message.startsWith("Undefined symbol")) {
                        canvasText.innerHTML = error.message;
                    }
                    return 0;
                }
            }

            function drawBlocks() {
                for(let x = 0; x < customCanvas.width+blockSize; x+=blockSize) {
                    for(let y = 0; y < customCanvas.height+blockSize; y+=blockSize) {
                        let xFrac = 2*x/customCanvas.width-1;
                        let yFrac = -2*y/customCanvas.height+1;
                        let lightness = calculateSpot(xFrac, yFrac);
                        if(onlySign) {
                            lightness = (lightness >= 0);
                        }
                        lightness = math.max(math.min(lightness, 1), 0);
                        if(gamma) {
                            lightness *= lightness;
                        }
                        let byte = lightness*255;
                        canvasContext.fillStyle = `rgb(${byte},${byte},${byte})`;
                        if(blockSize > 1) {
                            canvasContext.fillRect(x-blockSize/2,y-blockSize/2,blockSize,blockSize);
                        }
                        else {
                            canvasContext.fillRect(x,y,1,1);
                        }
                    }
                }
                if(canvasText.innerHTML == "Drawing") {
                    canvasText.innerHTML = "Finished";
                }
            }

            function drawFull() {
                expression = expressionField.value;
                try {
                    let nodes = math.parse(expression);
                    code = nodes.compile();
                }
                catch(error) {
                    canvasText.innerHTML = error.message;
                    return;
                }
                onlySign = styleCheckbox.checked;
                gamma = gammaCheckbox.checked;
                blockSize = Number(resolutionSlider.value);
                canvasText.innerHTML = "Drawing";
                setTimeout(drawBlocks);
            }
        </script>

    </body>
</html>