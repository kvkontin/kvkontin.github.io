<!DOCTYPE html>
<html lang="en">
    <head>
        <title>kvkontin</title>
        <meta charset="utf-8">
        <style>
            
            * {
                color: white;
                font-family: Verdana, sans-serif;
                font-size: 20px;
                background-color: #002b36;
            }

            canvas {
                /*width:100%;*/
                border:1px solid;
                image-rendering:crisp-edges;
            }

            .text {
                width: 640px;
            }

        </style>
        <script src="https://cdn.jsdelivr.net/npm/mathjs@9.4.4/lib/browser/math.js"></script>
    </head>

    <body>
        <canvas id="customCanvas" width="640" height="640">Canvas tags are not supported</canvas>
        <p id="canvasText">Waiting</p>
        <input id="style" type="checkbox">
        <label for="style">Only sign</label>
        <br>
        <input id="expression" class="text" type="text" value="x+sin(y)">
        <br>
        <input id="draw" type="button" value="Draw" onclick="drawFull()">
        <p></p>
        <img src="https://i.imgur.com/HOOCESq.png" width="100" height="100" alt="kvkontin">

        <script type="text/javascript">

            console.log(math.evaluate("2*pi"));
            console.log("that was math");

            const customCanvas = document.getElementById("customCanvas");
            const canvasContext = customCanvas.getContext("2d");
            const canvasText = document.getElementById("canvasText");
            const expressionField = document.getElementById("expression");
            const styleCheckbox = document.getElementById("style");
    
            let onlySign = false;
            let expression = "1";
            let mipmapLevels = [32, 8, 1];
            let mipmapIndex = 0;


            function calculateSpot(horizontal, vertical) {
                let scope = {
                    x: horizontal,
                    y: vertical
                }
                return math.evaluate(expression, scope);
            }

            function drawMipmapped() {
                blockSize = mipmapLevels[mipmapIndex];
                console.log("mipmapping at",blockSize);
                for(let x = 0; x < customCanvas.width+blockSize; x+=blockSize) {
                    for(let y = 0; y < customCanvas.height+blockSize; y+=blockSize) {
                        let xFrac = 2*x/customCanvas.width-1;
                        let yFrac = -2*y/customCanvas.height+1;
                        let lightness = calculateSpot(xFrac, yFrac);
                        if(onlySign) {
                            lightness = (lightness >= 0);
                        }
                        let byte = lightness*255;
                        canvasContext.fillStyle = `rgb(${byte},${byte},${byte})`;
                        if(blockSize > 1) {
                            canvasContext.fillRect(x-blockSize/2,y-blockSize/2,blockSize,blockSize);
                        }
                        else {
                            canvasContext.fillRect(x,y,1,1);
                        }
                    }
                }
                if(mipmapIndex < mipmapLevels.length-1) {
                    mipmapIndex += 1;
                    setTimeout(drawMipmapped, 0);
                }
                else {
                    canvasText.innerText = "Finished";
                }
            }

            function drawFull() {
                expression = expressionField.value;
                onlySign = styleCheckbox.checked;
                canvasText.innerText = "Drawing";
                console.log("Got ", expression);
                mipmapIndex = 0;
                drawMipmapped();
            }
        </script>

    </body>
</html>